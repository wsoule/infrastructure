<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Gateway Demo</title>
</head>
<body>
    <h1>API Gateway Reverse Proxy Demo</h1>
    <p>All requests go through the API Gateway at <strong>http://localhost:8080</strong></p>
    <p>The gateway routes requests to the appropriate backend microservices:</p>
    <ul>
        <li><code>/api/users/*</code> → User Service (port 8081)</li>
        <li><code>/api/products/*</code> → Product Service (port 8082)</li>
    </ul>

    <hr>

    <h2>Gateway Health Check</h2>
    <div id="health-status">Loading health status...</div>

    <hr>

    <h2>Users (via API Gateway)</h2>
    <h3>All Users</h3>
    <div id="users-list">Loading users...</div>

    <h3>Create New User</h3>
    <form id="create-user-form">
        <label>Name: <input type="text" name="name" required></label><br>
        <label>Email: <input type="email" name="email" required></label><br>
        <button type="submit">Create User</button>
    </form>
    <div id="create-user-response"></div>

    <h3>Get User by ID</h3>
    <form id="get-user-form">
        <label>User ID: <input type="number" name="id" required></label>
        <button type="submit">Get User</button>
    </form>
    <div id="get-user-response"></div>

    <hr>

    <h2>Products (via API Gateway)</h2>
    <h3>All Products</h3>
    <div id="products-list">Loading products...</div>

    <h3>Create New Product</h3>
    <form id="create-product-form">
        <label>Name: <input type="text" name="name" required></label><br>
        <label>Description: <input type="text" name="description"></label><br>
        <label>Price: <input type="number" step="0.01" name="price" required></label><br>
        <label>Stock: <input type="number" name="stock" required></label><br>
        <button type="submit">Create Product</button>
    </form>
    <div id="create-product-response"></div>

    <h3>Get Product by ID</h3>
    <form id="get-product-form">
        <label>Product ID: <input type="number" name="id" required></label>
        <button type="submit">Get Product</button>
    </form>
    <div id="get-product-response"></div>

    <script>
        const API_GATEWAY_URL = 'http://localhost:8080';

        // Auto-load data when page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadHealthStatus();
            loadUsers();
            loadProducts();
        });

        // Generic API call function
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_GATEWAY_URL}${endpoint}`, options);
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Health Check
        async function loadHealthStatus() {
            const result = await apiCall('/health');
            const el = document.getElementById('health-status');
            if (result.success) {
                el.innerHTML = '<strong>Gateway Status:</strong> ' + result.data.status + '<br>' +
                               '<strong>Services:</strong><pre>' + JSON.stringify(result.data.services, null, 2) + '</pre>';
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || 'Failed to check health');
            }
        }

        // Users
        async function loadUsers() {
            const result = await apiCall('/api/users');
            const el = document.getElementById('users-list');
            if (result.success) {
                if (result.data && result.data.length > 0) {
                    el.innerHTML = '<pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
                } else {
                    el.innerHTML = '<em>No users found</em>';
                }
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || JSON.stringify(result.data));
            }
        }

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const user = {
                name: formData.get('name'),
                email: formData.get('email')
            };
            const result = await apiCall('/api/users', 'POST', user);
            const el = document.getElementById('create-user-response');
            if (result.success) {
                el.innerHTML = '<strong>Success:</strong><pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
                e.target.reset();
                loadUsers(); // Reload the list
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || JSON.stringify(result.data));
            }
        });

        document.getElementById('get-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const id = formData.get('id');
            const result = await apiCall(`/api/users/${id}`);
            const el = document.getElementById('get-user-response');
            if (result.success) {
                el.innerHTML = '<strong>User #' + id + ':</strong><pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || JSON.stringify(result.data));
            }
        });

        // Products
        async function loadProducts() {
            const result = await apiCall('/api/products');
            const el = document.getElementById('products-list');
            if (result.success) {
                if (result.data && result.data.length > 0) {
                    el.innerHTML = '<pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
                } else {
                    el.innerHTML = '<em>No products found</em>';
                }
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || JSON.stringify(result.data));
            }
        }

        document.getElementById('create-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const product = {
                name: formData.get('name'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock'))
            };
            const result = await apiCall('/api/products', 'POST', product);
            const el = document.getElementById('create-product-response');
            if (result.success) {
                el.innerHTML = '<strong>Success:</strong><pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
                e.target.reset();
                loadProducts(); // Reload the list
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || JSON.stringify(result.data));
            }
        });

        document.getElementById('get-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const id = formData.get('id');
            const result = await apiCall(`/api/products/${id}`);
            const el = document.getElementById('get-product-response');
            if (result.success) {
                el.innerHTML = '<strong>Product #' + id + ':</strong><pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
            } else {
                el.innerHTML = '<strong>Error:</strong> ' + (result.error || JSON.stringify(result.data));
            }
        });
    </script>
</body>
</html>
